
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

  <title>KAOMA åº«å­˜ç³»çµ±</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 30px;
      background-color: #f8f8f8;
      color: #333;
    }

    h2, h3, h4 {
      color: #2c3e50;
      margin-top: 30px;
    }

    input, button, select, textarea {
      margin: 5px 10px 10px 0;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      resize: vertical;
    }

    button {
      background-color: #2980b9;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
      border-radius: 6px;
    }

    button:hover {
      background-color: #3498db;
    }

    .btn-secondary {
      background-color: #7f8c8d;
    }

    .btn-secondary:hover {
      background-color: #95a5a6;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #ecf0f1;
      font-weight: bold;
    }

    label {
      display: inline-block;
      margin-bottom: 10px;
    }

    .section {
      margin-bottom: 40px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }

    @media (max-width: 768px) {
      input, button, select, textarea {
        width: 100%;
        margin: 10px 0;
      }

      label {
        display: block;
      }
    }
  </style>
</head>
<body>
  <h2>KAOMA åº«å­˜ç³»çµ±</h2>

  <div class="section">
    <label>å•†å“åç¨±: <input id="product" type="text" oninput="fetchStockData()"></label>
    <label>æ•¸é‡: <input id="quantity" type="number"></label>
    <label>æˆæœ¬: <input id="cost" type="number" step="0.01" disabled></label>
    <label>å”®åƒ¹: <input id="price" type="number" step="0.01"></label>
    <label>ä¾›æ‡‰å•†: <input id="supplier" type="text" disabled></label>
    <label>é¡å‹:
      <select id="type" onchange="toggleFields()">
        <option value="in">é€²è²¨</option>
        <option value="out">å‡ºè²¨</option>
      </select>
    </label><br>
    <button onclick="addRecord()">é€å‡º</button>
    <button onclick="exportCSV()" class="btn-secondary">åŒ¯å‡º CSV</button>
    <button onclick="backupWithFileSystemAPI()" class="btn-secondary">å‚™ä»½åˆ°æª”æ¡ˆ</button>
    <button onclick="restoreFromFileSystemAPI()" class="btn-secondary">é‚„åŸå‚™ä»½</button>
    <a href="stock.html" target="_blank"><button class="btn-secondary">æŸ¥çœ‹åº«å­˜è¡¨ï¼ˆæ–°é é¢ï¼‰</button></a>
  </div>

  <div class="section">
    <h4>ğŸ“¥ å¤§é‡åŒ¯å…¥ (æ ¼å¼ï¼šå•†å“,æ•¸é‡,æˆæœ¬,å”®åƒ¹,ä¾›æ‡‰å•†,é¡å‹)</h4>
    <textarea id="bulkInput" rows="5"></textarea><br>
    <button onclick="bulkImport()">åŒ¯å…¥è³‡æ–™</button>
  </div>

  <div class="section">
    <h3>ğŸ“„ åº«å­˜è¨˜éŒ„</h3>
    <table>
      <thead>
        <tr><th>å•†å“</th><th>é€²è²¨</th><th>å‡ºè²¨</th><th>ç¾æœ‰åº«å­˜</th><th>æˆæœ¬</th><th>å”®åƒ¹</th><th>ä¾›æ‡‰å•†</th><th>é¡å‹</th><th>åˆ©æ½¤</th><th>åˆ©æ½¤ç‡</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody id="report"></tbody>
    </table>
  </div>

  <script>
    let records = JSON.parse(localStorage.getItem('inventory_records') || '[]');

    function saveToLocalStorage() {
      localStorage.setItem('inventory_records', JSON.stringify(records));
    }

    function toggleFields() {
      const type = document.getElementById('type').value;
      document.getElementById('cost').disabled = type === 'out';
      document.getElementById('supplier').disabled = type === 'out';
      fetchStockData();
    }

    function fetchStockData() {
      const productName = document.getElementById('product').value.trim();
      const productRecord = records.find(record => record.product === productName && record.type === 'in');
      if (productRecord) {
        document.getElementById('cost').value = productRecord.cost.toFixed(2);
        document.getElementById('supplier').value = productRecord.supplier;
        document.getElementById('quantity').value = '';
      } else {
        document.getElementById('cost').value = '';
        document.getElementById('supplier').value = '';
        document.getElementById('quantity').value = '';
      }
    }

    async function backupWithFileSystemAPI() {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: "inventory_backup.json",
          types: [{ description: "JSON File", accept: { "application/json": [".json"] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(JSON.stringify(records, null, 2));
        await writable.close();
        alert("å‚™ä»½æˆåŠŸï¼");
      } catch (err) {
        alert("å‚™ä»½å¤±æ•—");
      }
    }

    async function restoreFromFileSystemAPI() {
      try {
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: "JSON File", accept: { "application/json": [".json"] } }]
        });
        const file = await handle.getFile();
        const text = await file.text();
        records = JSON.parse(text);
        saveToLocalStorage();
        updateReport();
        alert("é‚„åŸæˆåŠŸï¼");
      } catch (err) {
        alert("é‚„åŸå¤±æ•—");
      }
    }

    function calculateCurrentStock(productName) {
      let stock = 0;
      records.forEach(r => {
        if (r.product === productName) {
          if (r.type === 'in') stock += r.quantity;
          else if (r.type === 'out') stock -= r.quantity;
        }
      });
      return stock;
    }

    function addRecord(record) {
      let product, quantity, cost, price, type, supplier;
      if (record) {
        ({ product, quantity, cost, price, type, supplier } = record);
      } else {
        product = document.getElementById('product').value.trim();
        quantity = parseInt(document.getElementById('quantity').value);
        cost = parseFloat(document.getElementById('cost').value);
        price = parseFloat(document.getElementById('price').value);
        supplier = document.getElementById('supplier').value.trim();
        type = document.getElementById('type').value;
      }

      if (!product || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0 || (type === 'in' && (isNaN(cost) || cost <= 0 || !supplier))) {
        alert('è«‹è¼¸å…¥æ­£ç¢ºçš„å•†å“åç¨±ã€æ•¸é‡ã€æˆæœ¬ã€å”®åƒ¹èˆ‡ä¾›æ‡‰å•†');
        return;
      }

      if (type === 'out') {
        const currentStock = calculateCurrentStock(product);
        if (quantity > currentStock) {
          alert(`åº«å­˜ä¸è¶³ï¼Œç¾æœ‰åº«å­˜åƒ…å‰© ${currentStock} ä»¶`);
          return;
        }
      }

      const profit = (price - cost) * (type === 'out' ? quantity : 0);
      const margin = cost > 0 ? ((price - cost) / cost * 100).toFixed(1) + '%' : '-';

      const recordData = { product, quantity, cost, price, type, supplier, profit, margin };
      records.push(recordData);
      saveToLocalStorage();
      updateReport();

      if (!record) {
        document.getElementById('product').value = '';
        document.getElementById('quantity').value = '';
        document.getElementById('cost').value = '';
        document.getElementById('price').value = '';
        document.getElementById('supplier').value = '';
      }
    }

    function bulkImport() {
      const text = document.getElementById('bulkInput').value.trim();
      const lines = text.split('\n');
      lines.forEach(line => {
        const [product, quantity, cost, price, supplier, type] = line.split(',').map(x => x.trim());
        if (product && quantity && type && supplier) {
          if (isNaN(quantity) || isNaN(cost) || isNaN(price)) {
            alert(`åŒ¯å…¥è³‡æ–™æ ¼å¼éŒ¯èª¤: ${line}`);
            return;
          }
          addRecord({
            product,
            quantity: parseInt(quantity),
            cost: parseFloat(cost),
            price: parseFloat(price),
            supplier,
            type
          });
        } else {
          alert(`æ ¼å¼éŒ¯èª¤: ${line}`);
        }
      });
      document.getElementById('bulkInput').value = '';
    }

    function deleteRecord(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
        records.splice(index, 1);
        saveToLocalStorage();
        updateReport();
      }
    }

    function editRecord(index) {
      const r = records[index];
      document.getElementById('product').value = r.product;
      document.getElementById('quantity').value = r.quantity;
      document.getElementById('cost').value = r.cost;
      document.getElementById('price').value = r.price;
      document.getElementById('supplier').value = r.supplier;
      document.getElementById('type').value = r.type;
      records.splice(index, 1);
      saveToLocalStorage();
      updateReport();
    }

    function updateReport() {
      const reportBody = document.getElementById('report');
      const fragment = document.createDocumentFragment();

      records.forEach((r, index) => {
        const profit = (r.price - r.cost) * (r.type === 'out' ? r.quantity : 0);
        const margin = r.cost > 0 ? ((r.price - r.cost) / r.cost * 100).toFixed(1) + '%' : '-';
        const currentStock = calculateCurrentStock(r.product);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${r.product}</td>
          <td>${r.type === 'in' ? r.quantity : ''}</td>
          <td>${r.type === 'out' ? r.quantity : ''}</td>
          <td>${currentStock}</td>
          <td>${(r.cost || 0).toFixed(2)}</td>
          <td>${(r.price || 0).toFixed(2)}</td>
          <td>${r.supplier}</td>
          <td>${r.type === 'in' ? 'é€²è²¨' : 'å‡ºè²¨'}</td>
          <td>${profit.toFixed(2)}</td>
          <td>${r.type === 'out' ? margin : '-'}</td>
          <td>
            <button onclick="editRecord(${index})">ä¿®æ”¹</button>
            <button onclick="deleteRecord(${index})">åˆªé™¤</button>
          </td>
        `;
        fragment.appendChild(row);
      });

      reportBody.innerHTML = '';
      reportBody.appendChild(fragment);
    }

    function exportCSV() {
      let csvContent = 'å•†å“,æ•¸é‡,æˆæœ¬,å”®åƒ¹,ä¾›æ‡‰å•†,é¡å‹,åˆ©æ½¤,åˆ©æ½¤ç‡\n';
      records.forEach(r => {
        const profit = (r.price - r.cost) * (r.type === 'out' ? r.quantity : 0);
        const margin = r.cost > 0 ? ((r.price - r.cost) / r.cost * 100).toFixed(1) + '%' : '-';
        csvContent += `${r.product},${r.quantity},${r.cost},${r.price},${r.supplier},${r.type},${profit.toFixed(2)},${r.type === 'out' ? margin : '-'}\n`;
      });
      const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'inventory_report.csv';
      link.click();
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateReport();
    });
  </script>
</body>
</html>
